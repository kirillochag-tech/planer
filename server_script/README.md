# Скрипт базы данных (СКБ)

## Назначение

Скрипт базы данных (СКБ) предназначен для обработки и записи данных в центральную базу данных. Он работает на отдельном сервере и отвечает за:

- Чтение файлов из сетевого каталога `//192.168.0.201/w/ftp/Logg/Input`
- Преобразование данных в нужный формат
- Запись данных в локальную базу данных SQLite
- Копирование базы данных в сетевой каталог

## Структура каталога

```
server_script/
├── db_script.py          # Основной скрипт базы данных
├── files/               # Каталог кэша для копирования файлов
└── README.md           # Документация
```

## Конфигурация

Скрипт использует следующие пути по умолчанию:

- **Локальная база данных**: `central_database.db`
- **Сетевая база данных**: `//192.168.0.201/w/ftp/Logg/Input/central_database.db`
- **Исходные файлы**: `//192.168.0.201/w/ftp/Logg/Input`
- **Каталог кэша**: `E:\server_script\files`

## Форматы файлов

Скрипт поддерживает обработку следующих форматов файлов:

- `.xml` - XML-файлы с данными о продажах
- `.txt` - текстовые файлы с табулированными данными

## Структура базы данных

База данных содержит следующие таблицы:

1. **sales_data** - данные о продажах:
   - id: INTEGER PRIMARY KEY
   - manager_id: TEXT (уникальный ID менеджера)
   - manager_name: TEXT (имя менеджера)
   - date: DATETIME (дата и время записи)
   - product_category: TEXT (категория продукта)
   - plan: REAL (план)
   - fact: REAL (факт)
   - percent: REAL (процент выполнения)
   - status: TEXT (статус: good, medium, bad)
   - data_type: TEXT (тип данных)
   - raw_data: TEXT (сырые данные в JSON-формате)

2. **managers** - информация о менеджерах:
   - id: TEXT PRIMARY KEY (уникальный ID менеджера)
   - name: TEXT (имя менеджера)
   - department: TEXT (отдел)
   - created_date: DATETIME (дата создания)

3. **data_dates** - даты с данными:
   - date: DATETIME PRIMARY KEY
   - processed_at: DATETIME (время обработки)

## Логика работы

1. Скрипт копирует файлы из сетевого каталога в локальный кэш, проверяя дату изменения
2. Обрабатывает XML и TXT файлы, извлекая данные о продажах
3. Удаляет предыдущие записи за те же сутки и сохраняет новые
4. Обновляет таблицу менеджеров
5. Копирует базу данных в сетевой каталог

## Запуск скрипта

### Прямой запуск

```bash
python db_script.py
```

### Запуск с параметрами командной строки

Для удобства запуска предусмотрен скрипт `run_db_script.py`:

```bash
python run_db_script.py [опции]
```

Доступные опции:

- `-c`, `--config` - путь к конфигурационному файлу (по умолчанию: config.json)
- `-v`, `--verbose` - подробный вывод информации
- `--test-config` - проверить конфигурационный файл и вывести параметры

Примеры:

```bash
# Запуск с указанием файла конфигурации
python run_db_script.py -c my_config.json

# Запуск в подробном режиме
python run_db_script.py -v

# Проверка конфигурации без запуска обработки
python run_db_script.py --test-config
```

## Требования

- Python 3.6+
- Модули: os, shutil, sqlite3, json, datetime, pathlib, xml.etree.ElementTree

## Особенности

- Каждый менеджер имеет уникальный ID, что позволяет отображать историю продаж даже при смене имени
- В базу данных записывается только последняя запись за сутки (предыдущие удаляются)
- Данные сохраняются в локальной БД, а затем копируются в сетевой каталог
- Поддерживаются два типа файлов: XML и TXT с табулированными данными